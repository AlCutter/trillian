// Copyright 2017 Google Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package cache

import (
	"bytes"
	"compress/gzip"
	"encoding/base64"
	"fmt"
	"io/ioutil"
	"testing"

	"github.com/golang/protobuf/proto"
	"github.com/google/trillian/merkle/rfc6962"
	"github.com/google/trillian/storage"
	"github.com/google/trillian/storage/storagepb"
	"github.com/kylelemons/godebug/pretty"
)

const goldenSubtreeNoIntermediatesB64 = "H4sIAAAAAAAA/1xYvW7kRhPEB1zw4WwDhmznBz0BZzj8CxTscrnLf1KBAoUHwZYBBQoU6O0Nw1u1sKvSxrCnu7q6uoc////+169f2vb14e7H+ffvf3zrv3/8+S1l9799/dIO3cPdT/9aQ2yuhw+ZHA45XDyJNa+uLi7v6iIrr+bezDHiwkc15zDPb2quC5jNSV1eAzlpIEWOw+a6RoqrmmOI97/8k+LTw90P//GBDA+aYYT1Ua0IolNAK5w9a2jM4/JsGCHrZVFzg9Obno55dnV9TBoG0tu1gjEFxNFpHAFJd5I0jY9iTLjsRb6PZMCzhlBfQxifNI3UXM2TFa9CwL1RLqB6Y1JzAd+bpRcB0f5kWaN+naJfIpD1xRjAw5piReCU+g2iu1iKWUCKn5Yi2fxiTAR6pw+lLXqt07JW9dV6GTQMIm33Fei15WA8Ir0Maeay1gYpzPuHmgvg0WkgJW4cBmtjUPSsnVIngPdh4EE4euvXANejNUXC6dEwLVCBLVmvAKj905IBIrulXrDhzJyjMhftoYZhW+oBDdNqcRNAnawyJTXJWJ2RqMZqtsZqenC7sdYbK5BM61XgwtGCThRSJXvJkmsqFUCazEUJSCfr2wo1314NUpze3szM9jIngYqnGeYI76BWdnP7rmhQjlWka7DjUtt14NJiXMoA0lERDWxQHRUNyZsZS8GZLbO0UatOYyZ0g0VHKu3GglsJF603MDqpthVUPEWuAusu1lkZa2KpkKOjMToh6PVg2AHpwQqbSBpThAoFmM13BVBnO10D1NkCrBHgYszL0AEX2zAysHoxEWo43LW6JZLsDamAG3uLj4I62PyjNM2m4eTk8m5hg8An1SCO1t6AChR8k3BWcjMx5AJzVLGOlHBt/gaV6Q29SPW1C3Pw7KicDJDTow7nCKYetQciWa2x3eR7sRbAXD0r2UmP0XYuKuFsQ7HC6X0w11z9VCC5ZpzeNDp080WzblCqwcZZDuQG4wxHzkHRD9xJdEVoEva2g+xtGYyvYoRWHXVti6SWei1h7ZRwJRfYV+seNMRkaxFPT8aW2x5mbCEv2k/FmK6tTiU12riccV3VqAMq0mpFyM5Oa0oCDNaWfCCNljiZuJrIcHfZTAUjh6EtoOTAbi+TxLq+SQnZPEqMyGGvhS0oUzZAIjO0qvD9NpkCUusmax8ufouZuZjOduVNNgxU4jGYfEVut9YT3M4WWzwaThzr2ICCbWamoHSKVEWxU/Fp4GIxmWcn90aFyPeMjbhIoGzkc96stmOwFw/ai9zwzjqv+TycTVEqMkRXnUgXmneN4C5WF07rzQjJuuw2mqikk83fis9wg4mPgMV2bD4CVpP0m+KpJvBBMxj5crq2pZKPs8226Ygy7laBggqimh6p9LoHJAJi/czVu9VFMYfjkxax5HZlXcctZbSdgR09G8dI1NXEkCP8qOBFDIGT8qPgoNUO4Kt7tHYu+KK30pbw3Cp0tz8QauV2NlszVzU071k0j49Mmy58LOzWWUUOFy/igiXRuUAPk3UQa7LYfQ18nLWsNbjYm4+A5hxtbCX+r7DBcJsuJskFfxRoAUuKlU6zmv9NjEik6GQaVrLdrFVCBewGwY5/MazbmPhuLhI3FyUSX3CtrmbcclpVu4RyryYzgdRYJDYg1ClCfCj0pkj8WTQZm/mgna3cNWXDwqDI9HY6cKjalQlOVuPobdlVOQmcTdop1NHBKpgj6sF68PY3UsnBcm+mrlwbDopewAw66l7EX8GdbuJs+bMmwl+tvTEmUC5tWUp19tf//g4AAP//V1xHUZcWAAA="

const goldenSubtreeB64 = "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"

func buildFullLogSubtree() *storagepb.SubtreeProto {
	r := &storagepb.SubtreeProto{
		Depth:             8,
		Leaves:            make(map[string][]byte),
		InternalNodeCount: 256 - 1 - 1,
	}
	for i := 0; i < 256; i++ {
		r.Leaves[storage.Suffix{Bits: 8, Path: []byte{byte(i)}}.String()] = []byte(fmt.Sprintf("Leaf Hash %d", i))
	}
	return r
}

func CreateGoldenSubtree(t *testing.T) {
	st := buildFullLogSubtree()
	fmt.Printf("no intermediate:\n%s\n", squashSubtree(t, st))
	LogPopulateFunc(rfc6962.DefaultHasher)(st)
	fmt.Printf("populated:\n%s\n", squashSubtree(t, st))
}

func squashSubtree(t *testing.T, st *storagepb.SubtreeProto) string {
	t.Helper()
	flat, err := proto.Marshal(st)
	if err != nil {
		t.Fatal(err)
	}
	b := bytes.Buffer{}
	w := gzip.NewWriter(&b)
	_, err = w.Write(flat)
	if err != nil {
		t.Fatal(err)
	}
	w.Close()
	b64 := base64.StdEncoding.EncodeToString(b.Bytes())
	return b64
}

func goldenSubtreeNoIntermediates(t *testing.T) *storagepb.SubtreeProto {
	t.Helper()
	return unsquashSubtree(t, goldenSubtreeNoIntermediatesB64)
}

func goldenSubtree(t *testing.T) *storagepb.SubtreeProto {
	t.Helper()
	return unsquashSubtree(t, goldenSubtreeB64)
}

func unsquashSubtree(t *testing.T, b64 string) *storagepb.SubtreeProto {
	gz, err := base64.StdEncoding.DecodeString(b64)
	if err != nil {
		t.Fatal(err)
	}
	r, err := gzip.NewReader(bytes.NewBuffer(gz))
	if err != nil {
		t.Fatal(err)
	}
	defer r.Close()
	raw, err := ioutil.ReadAll(r)
	if err != nil {
		t.Fatal(err)
	}
	var subtree storagepb.SubtreeProto
	if err := proto.Unmarshal(raw, &subtree); err != nil {
		t.Fatal(err)
	}
	return &subtree
}

func TestLogPopulation(t *testing.T) {
	f := LogPopulateFunc(rfc6962.DefaultHasher)

	for _, test := range []struct {
		name    string
		subtree *storagepb.SubtreeProto
		want    *storagepb.SubtreeProto
	}{
		{
			name:    "full1",
			subtree: goldenSubtreeNoIntermediates(t),
			want:    goldenSubtree(t),
		},
	} {
		t.Run(test.name, func(t *testing.T) {
			if err := f(test.subtree); err != nil {
				t.Fatalf("failed to repopulate subtree: %v", err)
			}
			if diff := pretty.Compare(test.want, test.subtree); diff != "" {
				t.Fatalf("unexpected repopulation - diff: %s", diff)
			}
		})
	}
}
